# üí≥ Payment System Setup Guide

## üëÅÔ∏è Overview

–í–∞—à–∞ –∏–≥—Ä–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **3 —Å–ø–æ—Å–æ–±–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è TON**:

1. ‚úÖ **Telegram Stars** - –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ
2. üöß **TON Wallet** - –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ê–°–¢–†–û–ô–ö–ê
3. üöß **–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã (YooKassa)** - –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ê–°–¢–†–û–ô–ö–ê

---

## ‚≠ê 1. Telegram Stars (–ì–û–¢–û–í–û!)

### ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢

**Telegram Stars** - —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ Telegram, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –ø—Ä—è–º–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

### üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –û–ø–ª–∞—Ç–∞ –≤–Ω—É—Ç—Ä–∏ Telegram
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Telegram
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π

### üí∞ –ü–∞–∫–µ—Ç—ã:
```
0.5 TON = 50 Stars
1.0 TON = 100 Stars
2.5 TON = 250 Stars
5.0 TON = 500 Stars
10.0 TON = 1000 Stars
```

### üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üí≥ –ö—É–ø–∏—Ç—å TON" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
2. –í—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç
3. –í—ã–±–∏—Ä–∞–µ—Ç "‚≠ê Telegram Stars"
4. Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ TON

### üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [Telegram's Bot Payments API Testing](https://core.telegram.org/bots/payments#testing-payments):

```bash
# –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ —Ç–µ—Å—Ç–æ–≤—É—é –≥—Ä—É–ø–ø—É BotFather
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ Stars (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
```

---

## üíé 2. TON Wallet Integration

### üöß –°—Ç–∞—Ç—É—Å: –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ê–°–¢–†–û–ô–ö–ê

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º TON blockchain –¥–ª—è –ø—Ä–∏—ë–º–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã.

### üõ†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

```bash
pip install pytonlib ton-python
```

#### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TON –∫–æ—à–µ–ª—ë–∫:

```python
# config.py
class Settings(BaseSettings):
    # ... existing settings ...
    
    # TON Wallet
    TON_WALLET_ADDRESS: str = "UQA..."  # –í–∞—à –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
    TON_API_KEY: str = ""  # API –∫–ª—é—á TON Center (https://toncenter.com)
    TON_NETWORK: str = "mainnet"  # mainnet –∏–ª–∏ testnet
```

#### 3. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:

```python
# app/services/ton_payments.py
from pytonlib import TonlibClient
import asyncio

class TONPaymentService:
    def __init__(self, api_key: str, wallet_address: str):
        self.api_key = api_key
        self.wallet_address = wallet_address
        self.client = TonlibClient(...)
    
    async def check_transaction(self, comment: str, expected_amount: float):
        """
        Check if transaction with specific comment exists.
        """
        # TODO: Implement blockchain checking
        transactions = await self.client.get_transactions(self.wallet_address)
        
        for tx in transactions:
            if tx.comment == comment and tx.amount == expected_amount:
                return True
        return False
    
    async def monitor_payments(self):
        """
        Background worker to monitor incoming payments.
        """
        while True:
            # Check for new transactions
            await asyncio.sleep(30)  # Check every 30 seconds
```

#### 4. –û–±–Ω–æ–≤–∏—Ç—å `payment.py`:

```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ pay_with_ton_wallet:
# –ó–∞–º–µ–Ω–∏—Ç—å placeholder –∞–¥—Ä–µ—Å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π:
deposit_address = settings.TON_WALLET_ADDRESS

# –í —Ñ—É–Ω–∫—Ü–∏–∏ check_ton_payment:
# –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:
ton_service = TONPaymentService(settings.TON_API_KEY, settings.TON_WALLET_ADDRESS)
if await ton_service.check_transaction(payment_memo, package['ton_crypto']):
    # Credit TON to user
    ...
```

#### 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```python
# main.py
async def main():
    # ... existing code ...
    
    # Start TON payment monitoring
    ton_service = TONPaymentService(...)
    asyncio.create_task(ton_service.monitor_payments())
    
    await dp.start_polling(bot)
```

### üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [TON Center API](https://toncenter.com/api/v2/)
- [PyTONLib Documentation](https://github.com/toncenter/pytonlib)
- [TON Documentation](https://docs.ton.org/)

---

## üí≥ 3. YooKassa (Russian Rubles)

### üöß –°—Ç–∞—Ç—É—Å: –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ê–°–¢–†–û–ô–ö–ê

–ü—Ä–∏—ë–º –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Ä—É–±–ª—è—Ö —á–µ—Ä–µ–∑ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã.

### üõ†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

#### 1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ YooKassa:

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ [yookassa.ru](https://yookassa.ru)
2. –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
3. –ü–æ–ª—É—á–∏—Ç—å:
   - `shopId` - ID –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
   - `secret_key` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á

#### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É:

```bash
pip install yookassa
```

#### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥:

```python
# config.py
class Settings(BaseSettings):
    # ... existing settings ...
    
    # YooKassa
    YOOKASSA_SHOP_ID: str = "123456"
    YOOKASSA_SECRET_KEY: str = "live_..."
    YOOKASSA_WEBHOOK_SECRET: str = "your_webhook_secret"
```

#### 4. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π:

```python
# app/services/yookassa_payments.py
from yookassa import Configuration, Payment
import uuid

Configuration.account_id = settings.YOOKASSA_SHOP_ID
Configuration.secret_key = settings.YOOKASSA_SECRET_KEY

class YooKassaService:
    @staticmethod
    def create_payment(amount_rub: float, user_id: int, package_id: str):
        """
        Create payment in YooKassa.
        """
        idempotence_key = str(uuid.uuid4())
        
        payment = Payment.create({
            "amount": {
                "value": f"{amount_rub:.2f}",
                "currency": "RUB"
            },
            "confirmation": {
                "type": "redirect",
                "return_url": "https://t.me/bearsmoney_bot"
            },
            "capture": True,
            "description": f"TON purchase - {package_id}",
            "metadata": {
                "user_id": user_id,
                "package_id": package_id
            }
        }, idempotence_key)
        
        return payment.confirmation.confirmation_url
```

#### 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook:

```python
# app/api/webhooks.py (create new file)
from fastapi import FastAPI, Request, HTTPException
from yookassa.domain.notification import WebhookNotification

app = FastAPI()

@app.post("/yookassa-webhook")
async def yookassa_webhook(request: Request):
    """
    Handle YooKassa payment notifications.
    """
    try:
        event_json = await request.json()
        notification = WebhookNotification(event_json)
        
        if notification.event == "payment.succeeded":
            payment = notification.object
            user_id = payment.metadata["user_id"]
            package_id = payment.metadata["package_id"]
            
            # Credit TON to user
            async with get_session() as session:
                user = await get_user(session, user_id)
                package = TON_PACKAGES[package_id]
                user.ton_balance += package['ton_amount']
                await session.commit()
                
            # Notify user
            await bot.send_message(
                user_id,
                f"‚úÖ –ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω!\n"
                f"üíé –ù–∞—á–∏—Å–ª–µ–Ω–æ: {package['ton_amount']} TON"
            )
        
        return {"status": "ok"}
    except Exception as e:
        logger.error(f"Webhook error: {e}")
        raise HTTPException(status_code=400, detail=str(e))
```

#### 6. –û–±–Ω–æ–≤–∏—Ç—å `payment.py`:

```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ pay_with_card:
payment_url = YooKassaService.create_payment(
    amount_rub=package['rub'],
    user_id=query.from_user.id,
    package_id=package_id
)

# –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É:
keyboard = InlineKeyboardMarkup(inline_keyboard=[
    [InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)],
    [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"select_package:{package_id}")],
])
```

#### 7. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å webhook –≤ YooKassa:

```python
from yookassa import Webhook

# –í–∞—à —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
Webhook.add({
    "event": "payment.succeeded",
    "url": "https://your-domain.com/yookassa-webhook"
})
```

### üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [YooKassa Documentation](https://yookassa.ru/developers)
- [YooKassa Python SDK](https://github.com/yoomoney/yookassa-sdk-python)
- [API Reference](https://yookassa.ru/developers/api)

---

## üîí Security

### –í–∞–∂–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ API –∫–ª—é—á–∏ –≤ Git!**
   ```bash
   # .env
   TON_API_KEY=your_key_here
   YOOKASSA_SECRET_KEY=your_key_here
   ```

2. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ webhook –ø–æ–¥–ø–∏—Å–∏:**
   ```python
   # YooKassa webhook verification
   if not verify_webhook_signature(request):
       raise HTTPException(status_code=401)
   ```

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ idempotency keys:**
   ```python
   # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
   idempotence_key = str(uuid.uuid4())
   ```

4. **–õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
   ```python
   logger.info(f"Payment: user={user_id}, amount={amount}, status={status}")
   ```

5. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ testnet/sandbox:**
   - TON: testnet
   - YooKassa: sandbox mode

---

## üîç Testing

### Telegram Stars:
```bash
# –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ—Ç–∞ - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É!
```

### TON Wallet:
```bash
# 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ testnet
export TON_NETWORK=testnet

# 2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ TON
# https://t.me/testgiver_ton_bot

# 3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
```

### YooKassa:
```bash
# 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏
export YOOKASSA_SECRET_KEY=test_...

# 2. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:
# 5555 5555 5555 4444 - —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂
# 5555 5555 5555 5599 - –æ—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
```

---

## ‚ùì Troubleshooting

### Telegram Stars –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω BotFather
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ payload —Ñ–æ—Ä–º–∞—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `journalctl -u bearsmoney -f`

### TON –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á TON Center
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞

### YooKassa webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook URL –≤ –ø–∞–Ω–µ–ª–∏ YooKassa
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook: `/var/log/nginx/access.log`

---

## üöÄ Quick Start Checklist

- [x] **Telegram Stars** - –ì–û–¢–û–í–û!
- [ ] **TON Wallet:**
  - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pytonlib
  - [ ] –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á TON Center
  - [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª—ë–∫
  - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] **YooKassa:**
  - [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
  - [ ] –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á–∏
  - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

---

## üí¨ Support

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f logs/bot.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:
   - TON: https://t.me/tondev
   - YooKassa: support@yookassa.ru
   - Telegram Bots: https://t.me/BotSupport

---

**–£–¥–∞—á–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π!** üöÄüêª
